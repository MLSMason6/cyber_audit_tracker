<?php
session_start();
require_once "includes/db_connect.php";
require_once "includes/log_action.php";

if (!isset($_SESSION['user_id'])) {
    header("Location: index.php");
    exit();
}

$message = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $title = trim($_POST['title']);
    $serverity = $_POST['severity'];
    $system_affected = trim($_POST['system_affected']);
    $description = trim($_POST['description']);
    $date_found = $_POST['date_found'];
    $created_by = $_POST['user_id'];

    if (!empty($title) && !empty($date_found)) {
        $stmt = $pdo->prepare("
            INSERT INTO Vulnerabilities (title, severity, status, system_affected, description, date_found, created_by)
            VALUES (:title, :severity, 'Open', :system_affected, :description, :date_found, :created_by)
        ");
        $stmt->execute([
            'title' => $title,
            'severity' => $serverity,
            'system_affected' => $system_affected,
            'description' => $description,
            'date_found' => $date_found,
            'created_by' => $created_by
        ]);

        // Log the action 
        logAction($pdo, $created_by, "Added vulnerability", "Title: $title, Severity: $severity");

        $message = "‚úÖ Vulnerability added successfully!";
    } else {
        $message = "‚ö†Ô∏è Please fill in all required fields.";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Add Vulnerability - Cybersecurity Audit Tracker</title>
    <style>
         body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
        }
        header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .container {
            max-width: 700px;
            margin: 30px auto;
            background: #fff;
            padding: 25px;
            border-raidus: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 { 
            color: #2c3e50;
            text-align: center; 
        }
        label { 
            display: block;
            margin-top: 10px;
            font-weight: bold; 
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        button { 
            background: #0078D4;
            color: white; 
            border: none;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius:6px; 
            cursor: pointer;
        }
        button:hover {
            background #005fa3
        }
        .msg { 
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        a { 
            display: inline-block;
            margin-top: 15px;
            color: #0078D4;
            text-decoration: none;
        }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <h1>üõ°Ô∏è Cybersecurity Audit Tracker</h1>
        <p>Welcome, <?= htmlspecialchars($_SESSION['username']) ?> (<?= htmlspecialchars($_SESSION['role']) ?>)</p>
        <p><a href="logout.php" style="color:yellow;text-decoration:none;">Logout</a></p>
    </header>

    <div class ="container">
        <h2>Add New Vulnerability</h2>

        <?php if ($message): ?>
            <p class="msg"><?= htmlspecialchars($message) ?></p>
        <?php endif; ?>

        <form method="POST">
            <label>Title:</label>
            <input type="text" name="title" placeholder="Enter vulnerability title" required>

            <label>Severity:</label>
            <select name="severity" required>
                <option value="">-- Select Severity --</option>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
            </select>

            <label>System Affected:</label>
            <input type="text" name="system_affected" placeholder="e.g. Authentication Module">
            
            <label>Description:</label>
            <textarea name="description" placeholder="Describe the issue and any observed behavior..." rows="5"></textarea>

            <label>Date Found:</label>
            <input type="date" name="date_found" required>

            <button type="submit">Add Vulnerability</button>
        </form>
    </div>
</body>
</html>